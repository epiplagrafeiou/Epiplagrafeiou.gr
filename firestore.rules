/**
 * @file Firestore Security Rules for Epipla Graphiou AI eShop.
 *
 * @corePhilosophy This ruleset enforces a strict role-based access control for administrative tasks and user-ownership for personal data.
 * All write operations are restricted to authorized users or roles. Schema validation is relaxed for prototyping,
 * focusing on authorization and relational integrity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Public read access, admin-only writes.
     */
    match /suppliers/{supplierId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Public read access, admin-only writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows a user to read and manage their own profile. Allows admins to read any profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false; // Explicitly prevent listing all users.
      allow create: if isSelfCreation(userId);
      allow update: if (isOwner(userId) || isAdmin()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Admin-only access.
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  function isSelfCreation(userId) {
      return request.auth.uid == userId && request.resource.data.id == userId;
  }

  function isAdmin() {
    return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}
