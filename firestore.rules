/**
 * @file Firestore Security Rules for Epipla Graphiou AI eShop.
 *
 * @corePhilosophy This ruleset enforces a strict role-based access control for administrative tasks and user-ownership for personal data.
 * All write operations are restricted to authorized users or roles. Schema validation is relaxed for prototyping,
 * focusing on authorization and relational integrity.
 *
 * @dataStructure
 * - `/suppliers/{supplierId}`: Stores supplier information.
 * - `/suppliers/{supplierId}/products/{productId}`: Stores product information related to a supplier.
 * - `/users/{userId}`: Stores user profile data.
 * - `/users/{userId}/orders/{orderId}`: Stores order information for a specific user.
 * - `/users/{userId}/carts/{cartId}`: Stores shopping cart data for a specific user.
 * - `/abandonedCarts/{abandonedCartId}`: Stores information about abandoned carts.
 * - `/newsletterSubscriptions/{newsletterSubscriptionId}`: Stores newsletter subscription information.
 * - `/roles_admin/{userId}`: Used to determine if a user has admin privileges.
 *
 * @keySecurityDecisions
 * - Admins are determined by the existence of a document in `/roles_admin/{userId}`.
 * - User data and associated resources (orders, carts) are strictly accessible only to the owning user or an admin.
 * - Denormalization: The `supplierId` is denormalized in the `Product` documents to facilitate simpler authorization rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows admins to manage suppliers.
     * @path /suppliers/{supplierId}
     * @allow (create, update, delete) if user is an admin (document exists in /roles_admin/{userId}).
     * @deny (create, update, delete) if user is not an admin.
     * @principle Enforces role-based access control for administrative tasks.
     */
    match /suppliers/{supplierId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows admins to manage products associated with a supplier.
     * @path /suppliers/{supplierId}/products/{productId}
     * @allow (create, update, delete) if user is an admin.
     * @deny (create, update, delete) if user is not an admin.
     * @principle Enforces role-based access control for administrative tasks.
     */
    match /suppliers/{supplierId}/products/{productId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows a user to read and manage their own profile. Allows admins to read any profile.
     * @path /users/{userId}
     * @allow (get, update, delete) if the user is the owner or an admin.
     * @allow create if the user id in the path matches the request auth uid (self-creation).
     * @deny (get, update, delete) if the user is not the owner and not an admin.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false; // Explicitly prevent listing all users.
      allow create: if isSelfCreation(userId);
      allow update: if (isOwner(userId) || isAdmin()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Allows a user to manage their own orders. Allows admins to read any order.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get, update, delete) if the user is the owner or an admin.
     * @allow create if the user is the owner (isOwner(userId)).
     * @deny (get, update, delete) if the user is not the owner and not an admin.
     * @principle Enforces user-ownership for order data.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if (isOwner(userId) || isAdmin()) && resource != null && request.resource.data.userId == resource.data.userId;
      allow delete: if (isExistingOwner(userId) || isAdmin());
    }

    /**
     * @description Allows a user to manage their own shopping cart.
     * @path /users/{userId}/carts/{cartId}
     * @allow (get, update, delete) if the user is the owner.
     * @allow create if the user is the owner (isOwner(userId)).
     * @deny (get, update, delete) if the user is not the owner.
     * @principle Enforces user-ownership for cart data.
     */
    match /users/{userId}/carts/{cartId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows admins to manage abandoned cart data.
     * @path /abandonedCarts/{abandonedCartId}
     * @allow (create, update, delete) if user is an admin (document exists in /roles_admin/{userId}).
     * @deny (create, update, delete) if user is not an admin.
     * @principle Enforces role-based access control for administrative tasks.
     */
    match /abandonedCarts/{abandonedCartId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Allows anyone to create newsletter subscriptions.
     * @path /newsletterSubscriptions/{newsletterSubscriptionId}
     * @allow (create) if true (no authentication required).
     * @deny (get, list, update, delete) to prevent unauthorized access.
     */
    match /newsletterSubscriptions/{newsletterSubscriptionId} {
      allow get, list: if false;
      allow create: if true;
      allow update, delete: if false;
    }

    /**
     * @description Determines if a user is an admin by checking for the existence of a document under roles_admin.
     * @path /roles_admin/{userId}
     * @allow (get, create, update, delete) if user id matches the path.
     * @deny (get, create, update, delete) if user id does not match path
     * @principle Existence check for determining user roles
     */
    match /roles_admin/{userId} {
        allow get: if isAdmin();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if isAdmin() && resource != null;
        allow delete: if isAdmin() && resource != null;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  function isSelfCreation(userId) {
      return request.auth.uid == userId && request.resource.data.id == userId;
  }

  function isAdmin() {
    return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}