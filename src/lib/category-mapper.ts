
'use server';

// A comprehensive map to unify supplier categories.
// Keywords are normalized (lowercase, no accents).
const categoryKeywordMap: { [keyword: string]: string[] } = {
  // Office Furniture
  'καρεκλες γραφειου': ['ΓΡΑΦΕΙΟ', 'Καρέκλες Γραφείου'],
  'gaming chairs': ['ΓΡΑΦΕΙΟ', 'Καρέκλες Γραφείου'],
  'διευθυντικ': ['ΓΡΑΦΕΙΟ', 'Καρέκλες Γραφείου'],
  'γραφεια': ['ΓΡΑΦΕΙΟ', 'Γραφεία'],
  'reception': ['Έπιπλα γραφείου', 'Reception'],
  'βιβλιοθηκεσ': ['ΓΡΑΦΕΙΟ', 'Βιβλιοθήκες'],
  'συρταριερεσ γραφειου': ['Έπιπλα γραφείου', 'Συρταριέρες γραφείου'],
  'ανταλλακτικα γραφειου': ['Έπιπλα γραφείου', 'Ανταλλακτικά γραφείου'],

  // Living Room
  'καναπεδες': ['ΣΑΛΟΝΙ', 'Καναπέδες'],
  'καναπ': ['ΣΑΛΟΝΙ', 'Καναπέδες'],
  'πολυθρονεσ': ['ΣΑΛΟΝΙ', 'Πολυθρόνες'],
  'πολυθρον': ['ΣΑΛΟΝΙ', 'Πολυθρόνες'],
  'τραπεζακια σαλονιου': ['ΣΑΛΟΝΙ', 'Τραπεζάκια Σαλονιού'],
  'επιπλα τηλεορασησ': ['ΣΑΛΟΝΙ', 'Έπιπλα Τηλεόρασης'],
  'συνθεσεις': ['ΣΑΛΟΝΙ', 'Συνθέσεις'],
  'σκαμπω': ['ΣΑΛΟΝΙ', 'Σκαμπό & Πουφ'],
  'πουφ': ['ΣΑΛΟΝΙ', 'Σκαμπό & Πουφ'],
  'επιπλα εισοδου': ['Έπιπλα εσωτερικού χώρου', 'Έπιπλα εισόδου'],
  'καλογεροι': ['Έπιπλα εσωτερικού χώρου', 'Καλόγεροι - Κρεμάστρες τοίχου'],
  'κρεμαστρες τοιχου': ['Έπιπλα εσωτερικού χώρου', 'Καλόγεροι - Κρεμάστρες τοίχου'],
  'κονσολεσ': ['Έπιπλα εσωτερικού χώρου', 'Κονσόλες'],
  'παπουτσοθηκεσ': ['Έπιπλα εσωτερικού χώρου', 'Παπουτσοθήκες'],
  'ραφιερεσ τοιχου': ['Έπιπλα εσωτερικού χώρου', 'Ραφιέρες τοίχου'],
  'τραπεζακια βοηθητικα': ['Έπιπλα εσωτερικού χώρου', 'Τραπεζάκια βοηθητικά'],


  // Bedroom
  'κρεβατια': ['ΚΡΕΒΑΤΟΚΑΜΑΡΑ', 'Κρεβάτια'],
  'στρωματα': ['ΚΡΕΒΑΤΟΚΑΜΑΡΑ', 'Στρώματα'],
  'κομοδινα': ['ΚΡΕΒΑΤΟΚΑΜΑΡΑ', 'Κομοδίνα'],
  'ντουλαπεσ': ['ΚΡΕΒΑΤΟΚΑΜΑΡΑ', 'Ντουλάπες'],
  'συρταριερεσ - τουαλετεσ': ['Έπιπλα εσωτερικού χώρου', 'Συρταριέρες - Τουαλέτες'],


  // Dining
  'τραπεζαριεσ': ['ΤΡΑΠΕΖΑΡΙΑ', 'Τραπέζια'],
  'τραπεζια': ['ΤΡΑΠΕΖΑΡΙΑ', 'Τραπέζια'],
  'καρεκλεσ κουζινασ': ['ΤΡΑΠΕΖΑΡΙΑ', 'Καρέκλες'],
  'καρεκλα τραπεζαριασ': ['ΤΡΑΠΕΖΑΡΙΑ', 'Καρέκλες'],
  'μπουφεδεσ': ['ΤΡΑΠΕΖΑΡΙΑ', 'Μπουφέδες'],
  'βιτρινεσ': ['ΤΡΑΠΕΖΑΡΙΑ', 'Βιτρίνες'],
  'stools': ['ΤΡΑΠΕΖΑΡΙΑ', 'Stools'],
  'σετ τραπεζαριεσ': ['Έπιπλα εσωτερικού χώρου', 'Σετ τραπεζαρίες'],

  // Outdoor
  'επιπλα κηπου': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Σετ Σαλονιού Κήπου'],
  'επιπλα βεραντασ': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Σετ Σαλονιού Κήπου'],
  'καρεκλεσ κηπου': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Καρέκλες Κήπου'],
  'ξαπλωστρεσ': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Ξαπλώστρες'],
  'αιωρεσ': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Αιώρες'],
  'πανι σκιασησ': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Λύσεις Σκίασης'],
  'τζακι εξωτερικου χωρου': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Τζάκια & Εστίες Φωτιάς'],
  'ψησταριεσ': ['ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ', 'Ψησταριές'],

  // Kitchen
  'επιπλα κουζινασ': ['Έπιπλα εσωτερικού χώρου', 'Έπιπλα κουζίνας'],
  'οργανωση κουζινασ': ['ΚΟΥΖΙΝΑ', 'Οργάνωση'],
  'μαχαιροπιρουνα': ['ΚΟΥΖΙΝΑ', 'Μαχαιροπίρουνα'],
  'εργαλεια κουζινασ': ['ΚΟΥΖΙΝΑ', 'Εργαλεία Μαγειρικής'],
  'κατσαρολεσ': ['ΚΟΥΖΙΝΑ', 'Μαγειρικά Σκεύη'],
  'τηγανια': ['ΚΟΥΖΙΝΑ', 'Μαγειρικά Σκεύη'],
  'πιατα': ['ΚΟΥΖΙΝΑ', 'Σερβίτσια'],
  'ποτηρια': ['ΚΟΥΖΙΝΑ', 'Ποτήρια & Κούπες'],
  'κουπεσ': ['ΚΟΥΖΙΝΑ', 'Ποτήρια & Κούπες'],
  'καφετιερεσ': ['ΚΟΥΖΙΝΑ', 'Μηχανές Καφέ'],
  'νησιδα κουζινασ': ['Έπιπλα κουζίνας', 'Νησίδα κουζίνας'],

  // Bathroom
  'επιπλα μπανιου': ['Έπιπλα εσωτερικού χώρου', 'Έπιπλα μπάνιου'],
  'αξεσουαρ μπανιου': ['ΑΛΛΑ', 'Αξεσουάρ Μπάνιου'],

  // Kids
  'παιδικο δωματιο': ['ΠΑΙΔΙΚΟ ΔΩΜΑΤΙΟ', 'Παιδικό Έπιπλο'],
  'παιδικο επιπλο': ['ΠΑΙΔΙΚΟ ΔΩΜΑΤΙΟ', 'Παιδικό Έπιπλο'],
  'παιχνιδια': ['ΠΑΙΔΙΚΟ ΔΩΜΑΤΙΟ', 'Παιχνίδια'],

  // Lighting
  'φωτισμοσ': ['ΦΩΤΙΣΜΟΣ', 'Γενικά'],
  'φωτιστικα': ['ΦΩΤΙΣΜΟΣ', 'Γενικά'],
  'led': ['ΦΩΤΙΣΜΟΣ', 'LED'],
  'λαμπτηρεσ': ['ΦΩΤΙΣΜΟΣ', 'Λάμπες'],
  'απλικεσ': ['Φωτισμός', 'Απλίκες'],
  'χριστουγεννιατικα λαμπακια led': ['ΦΩΤΙΣΜΟΣ', 'Χριστουγεννιάτικα Λαμπάκια Led'],
  'party lights': ['ΦΩΤΙΣΜΟΣ', 'Party Lights'],
  'γιρλαντεσ απο σχοινι': ['ΦΩΤΙΣΜΟΣ', 'Γιρλάντες απο Σχοινί'],
  'διακοσμητικεσ γιρλαντεσ led': ['ΦΩΤΙΣΜΟΣ', 'Διακοσμητικές Γιρλάντες LED'],
  'λαμπεσ διακοσμητικεσ & τυπου edison': ['ΦΩΤΙΣΜΟΣ', 'Λάμπες διακοσμητικές & τύπου Edison'],
  ' ταινιεσ led': ['ΦΩΤΙΣΜΟΣ', 'Ταινίες Led'],
  'φωτιστικα επιδαπεδια & επιτραπεζια': ['ΦΩΤΙΣΜΟΣ', 'Φωτιστικά Επιδαπέδια & Επιτραπέζια'],
  'φωτιστικα μπαταριασ & ηλιακα': ['ΦΩΤΙΣΜΟΣ', 'Φωτιστικά Μπαταρίας & Ηλιακά'],
  'φωτιστικα οροφησ': ['ΦΩΤΙΣΜΟΣ', 'Φωτιστικά Οροφής'],
  'χριστουγεννιατικα φωτεινα στοιχεια': ['ΦΩΤΙΣΜΟΣ', 'Χριστουγεννιάτικα Φωτεινά Στοιχεία'],

  // Decoration
  'διακοσμηση': ['ΔΙΑΚΟΣΜΗΣΗ', 'Γενικά'],
  'πινακεσ': ['ΔΙΑΚΟΣΜΗΣΗ', 'Πίνακες'],
  'φυτα': ['ΔΙΑΚΟΣΜΗΣΗ', 'Φυτά'],
  'κερια': ['ΔΙΑΚΟΣΜΗΣΗ', 'Κεριά'],
  'ρολογια': ['ΔΙΑΚΟΣΜΗΣΗ', 'Ρολόγια'],
  'χαλια': ['ΔΙΑΚΟΣΜΗΣΗ', 'Χαλιά'],
  'καθρεπτεσ': ['ΔΙΑΚΟΣΜΗΣΗ', 'Καθρέπτες'],
  'διακοσμηση τοιχου': ['Διακόσμηση', 'Διακόσμηση τοίχου'],

  // General & Uncategorized
  'ειδη σπιτιου': ['Άλλα είδη', 'Είδη σπιτιού'],
  'λευκα ειδη': ['Άλλα είδη', 'Λευκά είδη'],
  'μικροηλεκτρικεσ συσκευεσ': ['Άλλα είδη', 'Μικροηλεκτρικές συσκευές'],
  'οικιακεσ συσκευεσ': ['ΑΛΛΑ', 'Οικιακές Συσκευές'],
  'black friday offers': ['ΑΛΛΑ', 'BLACK FRIDAY OFFERS'],

};

function normalize(str: string): string {
  if (!str) return "";
  return str
    .trim()
    .toLowerCase()
    .replace(/[άάὰ]/g, 'α')
    .replace(/[έὲ]/g, 'ε')
    .replace(/[ήὴ]/g, 'η')
    .replace(/[ίϊΐὶ]/g, 'ι')
    .replace(/[όὸ]/g, 'ο')
    .replace(/[ύϋΰὺ]/g, 'υ')
    .replace(/[ώὼ]/g, 'ω')
    .replace(/[^a-zα-ω0-9\s>]/gi, '') // Allow > and spaces
    .replace(/\s+/g, ' '); // Consolidate whitespace
}

export async function mapCategory(raw: string): Promise<string> {
  const normalizedRaw = normalize(raw);

  // Direct keyword matching
  for (const keyword in categoryKeywordMap) {
    if (normalizedRaw.includes(keyword)) {
      return categoryKeywordMap[keyword].join(' > ');
    }
  }

  // Fallback for multi-level categories that didn't match a keyword
  const parts = raw.split('>').map(p => p.trim()).filter(Boolean);
  if (parts.length > 1) {
    // Attempt to find a match for the most specific part first
     for (let i = parts.length - 1; i >= 0; i--) {
       const partNorm = normalize(parts[i]);
       for (const keyword in categoryKeywordMap) {
         if (partNorm.includes(keyword)) {
           return categoryKeywordMap[keyword].join(' > ');
         }
       }
     }
    // If no specific part matches, return the first two levels as-is
    return parts.slice(0, 2).join(' > ');
  }

  // Final fallback
  if (parts.length === 1) {
    return `ΑΛΛΑ > ${parts[0]}`;
  }

  return "ΑΛΛΑ > Uncategorized";
}
