
'use server';

import { createSlug } from './utils';

function normalize(s: string): string {
  if (!s) return '';
  return s
    .toLowerCase()
    .replace(/\s+/g, ' ')
    .replace(/&nbsp;/g, ' ')
    .trim();
}

function extractCategory(raw: any): string {
  if (!raw) return "";

  // If category is simple string
  if (typeof raw === "string" || typeof raw === "number") {
    return String(raw);
  }

  // If category is array (common in XML)
  if (Array.isArray(raw)) {
    return raw
      .map(v => extractCategory(v))
      .filter(Boolean)
      .join(" > ");
  }

  // If category is object with known fields
  if (typeof raw === "object") {
    const values = Object.values(raw)
      .map(v => extractCategory(v))
      .filter(Boolean)
      .join(" > ");
    return values || "";
  }

  return String(raw);
}

const categoryMapping = [
    // --- Specific B2B Portal overrides ---
    { raw: 'βιβλιοθήκες > σαλόνι', mapped: 'ΓΡΑΦΕΙΟ > Βιβλιοθήκες' },
    { raw: 'ραφιέρες & αποθηκευτικά κουτιά > σαλόνι', mapped: 'ΓΡΑΦΕΙΟ > Ραφιέρες / Αποθηκευτικά Κουτιά' },
    { raw: 'επιπλα τηλεόρασης > σαλόνι', mapped: 'ΣΑΛΟΝΙ > Έπιπλα τηλεόρασης' },
    { raw: 'παπουτσοθήκες > σαλόνι', mapped: 'ΣΑΛΟΝΙ > Παπουτσοθήκες' },
    { raw: 'σαλονι > σκαμπό & πουφ', mapped: 'ΣΑΛΟΝΙ > Πουφ & Σκαμπό' },
    { raw: 'κουρτίνες & κουρτινόξυλα > σαλόνι', mapped: 'ΣΑΛΟΝΙ > Κουρτίνες & Κουρτινόξυλα' },
    { raw: 'στρώματα ύπνου φουσκωτά > οργάνωση σπιτιού', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Φουσκωτά στρώματα' },
    { raw: 'πολύμπριζα > εικόνα - ήχος', mapped: 'Αξεσουάρ > Πολύπριζα' },
    { raw: 'προεκτάσεις ρεύματος & μπαλαντέζες > εικόνα - ήχος', mapped: 'Αξεσουάρ > Πολύπριζα' },
    { raw: 'βάσεις τηλεόρασης > εικόνα - ήχος', mapped: 'Αξεσουάρ > Βάσεις Τηλεόρασης' },
    { raw: 'σταχτοδοχεία > οργάνωση σπιτιού', mapped: 'Αξεσουάρ > Σταχτοδοχεία' },
    { raw: 'στοπ πόρτας > οργάνωση σπιτιού', mapped: 'Αξεσουάρ > Στόπ Πόρτας' },
    { raw: 'άλλα είδη > είδη σπιτιού > σκάλες', mapped: 'Αξεσουάρ > Σκάλες' },
    { raw: 'φωτιστικά οροφής > φωτισμός', mapped: 'ΦΩΤΙΣΜΟΣ > Φωτιστικά οροφής' },
    { raw: 'φωτιστικά επιδαπέδια & επιτραπέζια > φωτισμός', mapped: 'ΦΩΤΙΣΜΟΣ > Φωτιστικά Δαπέδου' },
    { raw: 'ταινίες led > φωτισμός', mapped: 'ΦΩΤΙΣΜΟΣ > Ταινίες LED' },
    { raw: 'λάμπες διακοσμητικές & τύπου edison > επιπλα & φωτισμός', mapped: 'ΦΩΤΙΣΜΟΣ > Λάμπες διακοσμητικές & τύπου Edison' },
    { raw: 'γιρλάντες απο σχοινί > επιπλα & φωτισμός', mapped: 'ΦΩΤΙΣΜΟΣ > Γιρλάντες απο Σχοινί' },
    { raw: 'party lights > επιπλα & φωτισμός', mapped: 'ΦΩΤΙΣΜΟΣ > Φώτα Πάρτη' },
    { raw: 'διακοσμηση > φυτά', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Τεχνητά φυτά' },
    { raw: 'διακοσμηση > χαλιά', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Χαλιά' },
    { raw: 'λευκά είδη > σαλόνι > μαξιλάρια διακοσμητικά . εξωτερικού & εσωτερικού χώρου', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Διακοσμητικά Μαξιλάρια' },
    { raw: 'κεριά διακοσμητικά > διακόσμηση & ατμόσφαιρα', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Κεριά' },
    { raw: 'κουβέρτες & ριχτάρια > σαλόνι', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Κουβέρτες & Ριχτάρια' },
    { raw: 'επένδυση & διακόσμηση τοίχου > διακόσμηση & ατμόσφαιρα', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Επένδυση & Διακόσμηση Τοίχου' },
    { raw: 'σαλονι > καναπέδες', mapped: 'ΣΑΛΟΝΙ > Καναπέδες' },
    { raw: 'παπλωματοθήκες & κλινοσκεπάσματα > δωμάτιο', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Λευκά Είδη > Σετ Παπλωματοθήκες' },
    { raw: 'διακόσμηση & οργάνωση μπαλκονιού > κήπος - βεράντα', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Διακόσμηση & Οργάνωση Μπαλκονιού' },
    { raw: 'εξωτερικος χωρος > αιώρες', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Αιώρες Κήπου & Βεράντας' },
    { raw: 'λύσεις σκίασης για το μπαλκόνι και τον κήπο > κήπος - βεράντα', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Λυσεις σκίασης για μπαλκόνι' },
    { raw: 'φαναράκια > κήπος - βεράντα', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Φαναράκια' },
    { raw: 'κουτιά & μπαούλα κήπου > κήπος - βεράντα', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Κουτιά Αποθήκευσης Κήπου' },
    { raw: 'κρεμάστρες δαπέδου > οργάνωση σπιτιού', mapped: 'Αξεσουάρ > Κρεμάστρες Δαπέδου' },
    { raw: 'κάδοι απορριμάτων > οργάνωση σπιτιού', mapped: 'Αξεσουάρ > Κάδοι Απορριμμάτων' },
    { raw: 'κορνίζες > διακόσμηση & ατμόσφαιρα', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Κορνίζες'},
    { raw: 'ρολόγια εσωτερικού χώρου > διακόσμηση & ατμόσφαιρα', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Ρολόγια'},
    { raw: 'ψάθινα & υφασμάτινα καλάθια > διακόσμηση & ατμόσφαιρα', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Ψάθινα & Υφασμάτινα Καλάθια'},
    { raw: 'διακόσμηση & ατμόσφαιρα > extreme interior design', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Luxury Decor'},
    { raw: 'mε χριστουγεννιάτικη διάθεση! > χριστουγεννιάτικα δέντρα !', mapped: 'Χριστουγεννιάτικα > Χριστουγεννιάτικα Δέντρα' },
    { raw: 'βάσεις χριστουγεννιάτικων δέντρων > δέντρο ή δάσος φέτος τα χριστούγεννα ? μεγάλο το δίλημμα', mapped: 'Χριστουγεννιάτικα > Βάσεις Χριστουγεννιάτικων Δέντρων' },
    { raw: 'χριστουγεννιάτικα λαμπάκια led > φωτισμός', mapped: 'Χριστουγεννιάτικα > Χριστουγεννιάτικα λαμπάκια LED' },
    { raw: 'vintage ξύλινα στολίδια δέντρου > δέντρο ή δάσος φέτος τα χριστούγεννα ? μεγάλο το δίλημμα', mapped: 'Χριστουγεννιάτικα > Ξύλινα στολίδια δέντρου' },
    { raw: 'φάτνη χριστουγέννων > και αν δεν έχουμε ταξιδέψει κοιτάζοντας την !', mapped: 'Χριστουγεννιάτικα > Φάτνη Χριστουγέννων' },
    { raw: 'χριστουγεννιάτικα φωτεινά στοιχεία > φωτισμός', mapped: 'Χριστουγεννιάτικα > Χριστουγεννιάτικα Φωτεινά Στοιχεία' },
    { raw: 'διακόσμηση & deco σε εορταστικό πνεύμα > η διακόσμηση που θα μας βάλει στα χριστούγεννα', mapped: 'Χριστουγεννιάτικα > Χριστουγεννιάτικη Διακόσμηση' },
    { raw: 'μινιατούρες & στοιχεία για το χριστουγεννιάτικο χωριό > οταν ονειρευόμαστε το μαγικό χωριό…', mapped: 'Χριστουγεννιάτικα > Μινιατούρες & Στοιχεία για το Χριστουγεννιάτικο Χωριό' },
    { raw: 'κηροπήγια & κηροσβέστες > διακόσμηση & ατμόσφαιρα', mapped: 'Χριστουγεννιάτικα > Κηροπήγια & Κηροσβέστες' },
    { raw: 'χριστουγεννιάτικες φιγούρες > και αν δεν έχουμε ταξιδέψει κοιτάζοντας την !', mapped: 'Χριστουγεννιάτικα > Χριστουγεννιάτικες Φιγούρες' },

    // --- General Megapap Mappings (and fallbacks) ---
    { raw: 'έπιπλα γραφείου > γραφεία', mapped: 'ΓΡΑΦΕΙΟ > Γραφεία' },
    { raw: 'έπιπλα γραφείου > καρέκλες γραφείου', mapped: 'ΓΡΑΦΕΙΟ > Καρέκλες γραφείου' },
    { raw: 'έπιπλα γραφείου > συρταριέρες γραφείου', mapped: 'ΓΡΑΦΕΙΟ > Συρταριέρες Γραφείου' },
    { raw: 'έπιπλα εσωτερικού χώρου > βιβλιοθήκες', mapped: 'ΓΡΑΦΕΙΟ > Βιβλιοθήκες' },
    { raw: 'γραφειο > ραφιέρες', mapped: 'ΓΡΑΦΕΙΟ > Ραφιέρες / Αποθηκευτικά Κουτιά' },
    { raw: 'έπιπλα γραφείου > ντουλάπια γραφείου', mapped: 'ΓΡΑΦΕΙΟ > Ντουλάπες' },
    { raw: 'έπιπλα γραφείου > ανταλλακτικά γραφείου', mapped: 'ΓΡΑΦΕΙΟ > Ανταλλακτικά' },
    { raw: 'έπιπλα γραφείου > reception', mapped: 'ΓΡΑΦΕΙΟ > Γραφεία υποδοχής / Reception' },

    { raw: 'έπιπλα εσωτερικού χώρου > καναπέδες γωνιακοί', mapped: 'ΣΑΛΟΝΙ > Καναπέδες > Γωνιακοί καναπέδες' },
    { raw: 'έπιπλα εσωτερικού χώρου > καναπέδες - κρεβάτι', mapped: 'ΣΑΛΟΝΙ > Καναπέδες > Καναπές Κρεβάτι' },
    { raw: 'έπιπλα εσωτερικού χώρου > καναπέδες', mapped: 'ΣΑΛΟΝΙ > Καναπέδες' },
    { raw: 'έπιπλα εσωτερικού χώρου > πολυθρόνες σαλονιού', mapped: 'ΣΑΛΟΝΙ > Πολυθρόνες' },
    { raw: 'έπιπλα εσωτερικού χώρου > πολυθρόνες - κρεβάτι', mapped: 'ΣΑΛΟΝΙ > Πολυθρόνες' },
    { raw: 'έπιπλα εσωτερικού χώρου > καρέκλες - πολυθρόνες τραπεζαρίας', mapped: 'ΣΑΛΟΝΙ > Καρέκλες τραπεζαρίας' },
    { raw: 'έπιπλα εσωτερικού χώρου > τραπέζια', mapped: 'ΣΑΛΟΝΙ > Τραπέζια' },
    { raw: 'έπιπλα εσωτερικού χώρου > τραπεζάκια σαλονιού', mapped: 'ΣΑΛΟΝΙ > Τραπεζάκια σαλονιού' },
    { raw: 'έπιπλα εσωτερικού χώρου > τραπεζάκια βοηθητικά', mapped: 'ΣΑΛΟΝΙ > Τραπεζάκια Βοηθητικά' },
    { raw: 'έπιπλα εσωτερικού χώρου > έπιπλα τηλεόρασης', mapped: 'ΣΑΛΟΝΙ > Έπιπλα τηλεόρασης' },
    { raw: 'έπιπλα εσωτερικού χώρου > συνθέσεις σαλονιού', mapped: 'ΣΑΛΟΝΙ > Συνθέσεις Σαλονιού' },
    { raw: 'έπιπλα εσωτερικού χώρου > έπιπλα εισόδου', mapped: 'ΣΑΛΟΝΙ > Έπιπλα Εισόδου' },
    { raw: 'έπιπλα εσωτερικού χώρου > παπουτσοθήκες', mapped: 'ΣΑΛΟΝΙ > Παπουτσοθήκες' },
    { raw: 'έπιπλα εσωτερικού χώρου > μπουφέδες', mapped: 'ΣΑΛΟΝΙ > Μπουφέδες' },
    { raw: 'έπιπλα εσωτερικού χώρου > κονσόλες', mapped: 'ΣΑΛΟΝΙ > Κονσόλες' },
    { raw: 'έπιπλα εσωτερικού χώρου > σκαμπώ μπαρ', mapped: 'ΣΑΛΟΝΙ > Σκαμπώ μπαρ' },
    { raw: 'έπιπλα εσωτερικού χώρου > σκαμπώ', mapped: 'ΣΑΛΟΝΙ > Πουφ & Σκαμπό' },

    { raw: 'έπιπλα εσωτερικού χώρου > κρεβάτια', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Κρεβάτια' },
    { raw: 'κρεβατοκαμαρα > κομοδίνα', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Κομοδίνα' },
    { raw: 'έπιπλα εσωτερικού χώρου > κομοδίνα', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Κομοδίνα' },
    { raw: 'σαλονι > κομοδίνα', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Κομοδίνα' },
    { raw: 'έπιπλα εσωτερικού χώρου > συρταριέρες - τουαλέτες', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Συρταριέρες' },
    { raw: 'έπιπλα εσωτερικού χώρου > ντουλάπες ρούχων', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Ντουλάπες' },
    { raw: 'άλλα είδη > λευκά είδη > μαξιλαροθήκες', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Λευκά Είδη > Μαξιλαροθήκες' },
    { raw: 'άλλα είδη > λευκά είδη > σεντόνια', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Λευκά Είδη > Σεντόνια' },
    { raw: 'άλλα είδη > λευκά είδη > σετ παπλωματοθήκες', mapped: 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Λευκά Είδη > Σετ Παπλωματοθήκες' },

    { raw: 'έπιπλα κήπου > πολυθρόνες - καρέκλες κήπου', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Καρέκλες κήπου' },
    { raw: 'έπιπλα κήπου > τραπέζια κήπου', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Τραπέζια εξωτερικού χώρου' },
    { raw: 'έπιπλα κήπου > σετ τραπεζαρίες κήπου', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Σετ τραπεζαρίες κήπου' },
    { raw: 'έπιπλα κήπου > βάσεις ομπρελών', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Βάσεις ομπρελών' },
    { raw: 'έπιπλα κήπου > ομπρέλες κήπου - παραλίας', mapped: 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Ομπρέλες κήπου / παραλίας' },
    { raw: 'έπιπλα εσωτερικού χώρου > καλόγεροι - κρεμάστρες τοίχου', mapped: 'Αξεσουάρ > Καλόγεροι' },

    { raw: 'φωτισμός > οροφής φωτιστικά', mapped: 'ΦΩΤΙΣΜΟΣ > Φωτιστικά οροφής' },
    { raw: 'φωτισμός > δαπέδου φωτιστικά', mapped: 'ΦΩΤΙΣΜΟΣ > Φωτιστικά Δαπέδου' },
    { raw: 'φωτισμός > επιτραπέζια φωτιστικά', mapped: 'ΦΩΤΙΣΜΟΣ > Επιτραπέζια φωτιστικά' },
    { raw: 'φωτισμός > απλίκες', mapped: 'ΦΩΤΙΣΜΟΣ > Απλίκες' },
    { raw: 'φωτισμός > παιδικά φωτιστικά οροφής', mapped: 'ΦΩΤΙΣΜΟΣ > Παιδικά φωτιστικά οροφής' },

    { raw: 'διακόσμηση > πίνακες', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Πίνακες' },
    { raw: 'έπιπλα εσωτερικού χώρου > καθρέπτες', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Καθρέπτες' },
    { raw: 'διακόσμηση > διακόσμηση τοίχου', mapped: 'ΔΙΑΚΟΣΜΗΣΗ > Επένδυση & Διακόσμηση Τοίχου' },
];

export async function getCategoryMapping() {
  return categoryMapping;
}

export async function mapCategory(rawCategory: any, productName: string): Promise<{ category: string, categoryId: string | null }> {
    const extracted = extractCategory(rawCategory);
    const normalizedRaw = normalize(extracted);
    const normalizedProductName = productName.toLowerCase();

    // --- Conditional Rules ---
    if (normalizedRaw.includes('καρέκλες & πολυθρόνες > σαλόνι')) {
      if (normalizedProductName.includes('καρέκλα')) {
        const cat = 'ΣΑΛΟΝΙ > Καρέκλες τραπεζαρίας';
        return { category: cat, categoryId: `cat-${createSlug(cat)}` };
      }
    }

    if (normalizedRaw.includes('σαλονι > τραπεζάκια σαλονιού')) {
      if (normalizedProductName.includes('τραπεζάκι βοηθητικό')) {
        const cat = 'ΣΑΛΟΝΙ > Τραπεζάκια Βοηθητικά';
        return { category: cat, categoryId: `cat-${createSlug(cat)}` };
      }
    }
    
    if (normalizedRaw.includes('κρεμάστρες & καλόγεροι > οργάνωση σπιτιού')) {
        if (normalizedProductName.includes('καλόγερος') || normalizedProductName.includes('καλογερος')) {
            const cat = 'Αξεσουάρ > Καλόγεροι';
            return { category: cat, categoryId: `cat-${createSlug(cat)}` };
        }
        if (normalizedProductName.includes('κρεμάστρ')) {
            const cat = 'Αξεσουάρ > Κρεμάστρες Δαπέδου';
            return { category: cat, categoryId: `cat-${createSlug(cat)}` };
        }
    }

    if (normalizedRaw.includes('επένδυση & διακόσμηση τοίχου > διακόσμηση & ατμόσφαιρα')) {
        if (normalizedProductName.includes('αυτοκόλλητα πλακάκια μωσαϊκό')) {
            return { category: extracted, categoryId: null }; 
        }
    }

    // --- Static Mapping ---
    for (const mapping of categoryMapping) {
      if (normalizedRaw.includes(normalize(mapping.raw))) {
        return { category: mapping.mapped, categoryId: `cat-${createSlug(mapping.mapped)}` };
      }
    }

    // Fallback
    return { category: extracted || "Uncategorized", categoryId: null };
}

    