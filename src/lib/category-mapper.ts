
'use server';

function normalize(s: string | null | undefined) {
  if (!s) return '';
  return s
    .toLowerCase()
    .replace(/\u00A0/g, ' ')
    .replace(/[’'"]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

/**
 * Static mapping table:
 * key = normalized supplier path (raw)
 * value = mapped path on your site
 *
 * Add / tweak entries here for any supplier-specific remapping.
 */
const STATIC_MAP: Record<string, string> = {
  // office / ΓΡΑΦΕΙΟ mappings
  'βιβλιοθήκες > σαλόνι': 'ΓΡΑΦΕΙΟ > Βιβλιοθήκες',
  'ραφιέρες & αποθηκευτικά κουτιά > σαλόνι': 'ΓΡΑΦΕΙΟ > Ραφιέρες / Αποθηκευτικά Κουτιά',
  'έπιπλα γραφείου > γραφεία': 'ΓΡΑΦΕΙΟ > Γραφεία',
  'έπιπλα γραφείου > καρέκλες γραφείου': 'ΓΡΑΦΕΙΟ > Καρέκλες γραφείου',
  'έπιπλα γραφείου > συρταριέρες γραφείου': 'ΓΡΑΦΕΙΟ > Συρταριέρες Γραφείου',
  'έπιπλα γραφείου > ντουλάπια γραφείου': 'ΓΡΑΦΕΙΟ > Ντουλάπες',
  'έπιπλα γραφείου > ανταλλακτικά γραφείου': 'ΓΡΑΦΕΙΟ > Ανταλλακτικά',
  'έπιπλα γραφείου > reception': 'ΓΡΑΦΕΙΟ > Γραφεία υποδοχής / Reception',

  // salon / ΣΑΛΟΝΙ
  'έπιπλα εσωτερικού χώρου > καναπέδες γωνιακοί': 'ΣΑΛΟΝΙ > Καναπέδες > Γωνιακοί καναπέδες',
  'έπιπλα εσωτερικού χώρου > καναπέδες - κρεβάτι': 'ΣΑΛΟΝΙ > Καναπέδες > Καναπές Κρεβάτι',
  'έπιπλα εσωτερικού χώρου > καναπέδες': 'ΣΑΛΟΝΙ > Καναπέδες',
  'έπιπλα εσωτερικού χώρου > πολυθρόνες σαλονιού': 'ΣΑΛΟΝΙ > Πολυθρόνες',
  'έπιπλα εσωτερικού χώρου > τραπέζια': 'ΣΑΛΟΝΙ > Τραπέζια',
  'έπιπλα εσωτερικού χώρου > τραπεζάκια σαλονιού': 'ΣΑΛΟΝΙ > Τραπεζάκια σαλονιού',
  'έπιπλα εσωτερικού χώρου > τραπεζάκια βοηθητικά': 'ΣΑΛΟΝΙ > Τραπεζάκια Βοηθητικά',
  'παπουτσοθήκες > σαλόνι': 'ΣΑΛΟΝΙ > Παπουτσοθήκες',
  'έπιπλα τηλεόρασης > σαλόνι': 'ΣΑΛΟΝΙ > Έπιπλα τηλεόρασης',

  // bedroom / ΚΡΕΒΑΤΟΚΑΜΑΡΑ
  'έπιπλα εσωτερικού χώρου > κρεβάτια': 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Κρεβάτια',
  'έπιπλα εσωτερικού χώρου > κομοδίνα': 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Κομοδίνα',
  'έπιπλα εσωτερικού χώρου > συρταριέρες - τουαλέτες': 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Συρταριέρες',
  'έπιπλα εσωτερικού χώρου > ντουλάπες ρούχων': 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Ντουλάπες',
  'στρώματα ύπνου φουσκωτά > οργάνωση σπιτιού': 'ΚΡΕΒΑΤΟΚΑΜΑΡΑ > Φουσκωτά στρώματα',

  // outdoor / ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ
  'έπιπλα κήπου > πολυθρόνες - καρέκλες κήπου': 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Καρέκλες κήπου',
  'έπιπλα κήπου > τραπέζια κήπου': 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Τραπέζια εξωτερικού χώρου',
  'έπιπλα κήπου > σετ τραπεζαρίες κήπου': 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Σετ τραπεζαρίες κήπου',
  'έπιπλα κήπου > βάσεις ομπρελών': 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Βάσεις ομπρελών',
  'έπιπλα κήπου > ομπρέλες κήπου - παραλίας': 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Ομπρέλες κήπου / παραλίας',
  'κουτιά & μπαούλα κήπου > κήπος - βεράντα': 'ΕΞΩΤΕΡΙΚΟΣ ΧΩΡΟΣ > Κουτιά Αποθήκευσης Κήπου',

  // accessories / ΑΞΕΣΟΥΑΡ
  'πολύμπριζα > εικόνα - ήχος': 'Αξεσουάρ > Πολύπριζα',
  'προεκτάσεις ρεύματος & μπαλαντέζες > εικόνα - ήχος': 'Αξεσουάρ > Πολύπριζα',
  'βάσεις τηλεόρασης > εικόνα - ήχος': 'Αξεσουάρ > Βάσεις Τηλεόρασης',
  'σταχτοδοχεία > οργάνωση σπιτιού': 'Αξεσουάρ > Σταχτοδοχεία',
  'στοπ πόρτας > οργάνωση σπιτιού': 'Αξεσουάρ > Στόπ Πόρτας',
  'άλλα είδη > είδη σπιτιού > σκάλες': 'Αξεσουάρ > Σκάλες',

  // lighting / ΦΩΤΙΣΜΟΣ
  'φωτιστικά οροφής > φωτισμός': 'ΦΩΤΙΣΜΟΣ > Φωτιστικά οροφής',
  'φωτιστικά επιδαπέδια & επιτραπέζια > φωτισμός': 'ΦΩΤΙΣΜΟΣ > Φωτιστικά Δαπέδου',
  'ταινίες led > φωτισμός': 'ΦΩΤΙΣΜΟΣ > Ταινίες Led',
  'λάμπες διακοσμητικές & τύπου edison > επιπλα & φωτισμός': 'ΦΩΤΙΣΜΟΣ > Λάμπες διακοσμητικές & τύπου Edison',
  'γιρλάντες απο σχοινί > επιπλα & φωτισμός': 'ΦΩΤΙΣΜΟΣ > Γιρλάντες απο Σχοινί',
  'party lights > επιπλα & φωτισμός': 'ΦΩΤΙΣΜΟΣ > Φώτα Πάρτη',

  // decoration / ΔΙΑΚΟΣΜΗΣΗ
  'διακοσμηση > φυτά': 'ΔΙΑΚΟΣΜΗΣΗ > Τεχνητά φυτά',
  'διακοσμηση > χαλιά': 'ΔΙΑΚΟΣΜΗΣΗ > Χαλιά',
  'κεριά διακοσμητικά > διακόσμηση & ατμόσφαιρα': 'ΔΙΑΚΟΣΜΗΣΗ > Κεριά',
  'κουβέρτες & ριχτάρια > σαλόνι': 'ΔΙΑΚΟΣΜΗΣΗ > Κουβέρτες & Ριχτάρια',
  'επένδυση & διακόσμηση τοίχου > διακόσμηση & ατμόσφαιρα': 'ΔΙΑΚΟΣΜΗΣΗ > Επένδυση & Διακόσμηση Τοίχου',
  'διακόσμηση & ατμόσφαιρα > extreme interior design': 'ΔΙΑΚΟΣΜΗΣΗ > Luxury Decor',

  // christmas
  'mε χριστουγεννιάτικη διάθεση! > χριστουγεννιάτικα δέντρα !': 'ΧΡΙΣΤΟΥΓΕΝΝΙΑΤΙΚΑ > Χριστουγεννιάτικα Δέντρα',
  'χριστουγεννιάτικα λαμπάκια led > φωτισμός': 'ΧΡΙΣΤΟΥΓΕΝΝΙΑΤΙΚΑ > Χριστουγεννιάτικα λαμπάκια LED',
  // ... add more as needed
};

/**
 * mapCategory(rawCategory, productName?)
 * - rawCategory: supplier category string like "Έπιπλα γραφείου > Γραφεία" (or any raw)
 * - returns: mapped path (string). If no static match found, returns a cleaned version of the raw.
 *
 * IMPORTANT: This function does NOT mutate the raw. Parsers should keep rawCategory separately.
 */
export async function mapCategory(rawCategory: any, productName?: string): Promise<string> {
  const extracted = Array.isArray(rawCategory) ? rawCategory.join(' > ') : String(rawCategory ?? '').trim();
  const key = normalize(extracted);

  // exact static match first
  if (key && STATIC_MAP[key]) return STATIC_MAP[key];

  // heuristics: try to match suffix or prefix parts
  const parts = key.split(' > ').map(p => p.trim()).filter(Boolean);
  for (let i = 0; i < parts.length; i++) {
    const candidate = parts.slice(i).join(' > ');
    if (candidate && STATIC_MAP[candidate]) return STATIC_MAP[candidate];
  }

  // productName based tweaks (small rules)
  if (productName) {
    const name = productName.toLowerCase();
    if (name.includes('καναπ') && key.includes('καναπ')) return 'ΣΑΛΟΝΙ > Καναπέδες';
    if (name.includes('καρέκλα') && key.includes('καρέκλες')) return 'ΓΡΑΦΕΙΟ > Καρέκλες γραφείου';
  }

  // fallback: return cleaned readable form of supplier raw (capitalized words)
  const fallback = parts
    .map(p =>
      p
        .split(' ')
        .filter(Boolean)
        .map(word => word.length > 0 ? word[0].toUpperCase() + word.slice(1) : '')
        .join(' ')
    )
    .filter(Boolean)
    .join(' > ');

  return fallback || String(rawCategory ?? '');
}

export async function getMappingTable() {
  return STATIC_MAP;
}
